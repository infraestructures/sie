<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <title>Gesti√≥ de contractes menors - Infraestructures Educatives</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f3f4f6;
      --bg-card: #ffffff;
      --border: #e5e7eb;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --text: #111827;
      --text-soft: #6b7280;
      --danger: #b91c1c;
      --radius-lg: 14px;
      --radius-xl: 18px;
      --shadow-soft: 0 10px 25px rgba(0,0,0,0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #e0f2fe, #f9fafb 45%);
      color: var(--text);
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(14px);
      background: linear-gradient(to right, rgba(249,250,251,0.92), rgba(239,246,255,0.92));
      border-bottom: 1px solid rgba(209,213,219,0.7);
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-pill {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #bfdbfe, #1d4ed8);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      box-shadow: 0 10px 20px rgba(37,99,235,0.5);
    }

    .header-title h1 {
      font-size: 1.1rem;
      margin: 0;
    }

    .header-title p {
      margin: 0;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .header-badge {
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(37,99,235,0.3);
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 13px;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(to right, #2563eb, #1d4ed8);
      color: #ffffff;
      box-shadow: 0 10px 20px rgba(37,99,235,0.4);
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-soft);
    }

    main {
      max-width: 1200px;
      margin: 14px auto 30px;
      padding: 0 16px 16px;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 3fr) minmax(0, 2fr);
      gap: 16px;
    }

    @media (max-width: 1024px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(209,213,219,0.8);
      padding: 16px 16px 14px;
    }

    .card h2 {
      margin: 0 0 8px;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .muted {
      color: var(--text-soft);
      font-size: 0.8rem;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    @media (max-width: 600px) {
      .filters-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    label {
      font-size: 0.78rem;
      color: var(--text-soft);
      display: block;
      margin-bottom: 2px;
    }

    input[type="text"],
    select,
    input[type="date"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 7px 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 0.8rem;
      outline: none;
      background: #f9fafb;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
      font-family: inherit;
      resize: vertical;
    }

    input[type="text"]:focus,
    select:focus,
    input[type="date"]:focus,
    input[type="number"]:focus,
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.4);
      background: #ffffff;
    }

    textarea {
      min-height: 70px;
    }

    .pill-input {
      border-radius: 999px !important;
    }

    .chip-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .chip {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.74rem;
      color: var(--text-soft);
      background: #f9fafb;
      cursor: pointer;
      user-select: none;
    }

    .chip.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 500;
    }

    .list-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .summary {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.8rem;
    }

    .summary-pill {
      padding: 3px 8px;
      border-radius: 999px;
      background: #f9fafb;
      border: 1px dashed var(--border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .summary-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #4b5563;
    }

    .summary-dot.obres {
      background: #7c3aed;
    }

    .summary-dot.equip {
      background: #15803d;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      margin-top: 4px;
    }

    thead {
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 1;
    }

    th, td {
      padding: 6px 6px;
      text-align: left;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: top;
    }

    th {
      font-weight: 600;
      font-size: 0.73rem;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    tbody tr {
      cursor: pointer;
      transition: background 0.08s, transform 0.06s;
    }

    tbody tr:hover {
      background: #f3f4ff;
      transform: translateY(-1px);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 0.7rem;
      border: 1px solid transparent;
    }

    .tag-obres {
      background: #ede9fe;
      color: #5b21b6;
      border-color: #ddd6fe;
    }

    .tag-equipament {
      background: #dcfce7;
      color: #166534;
      border-color: #bbf7d0;
    }

    .badge-estat {
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 0.7rem;
      font-weight: 500;
    }

    .estat-tramit {
      background: #fef9c3;
      color: #854d0e;
    }

    .estat-curs {
      background: #e0f2fe;
      color: #1d4ed8;
    }

    .estat-tancat {
      background: #dcfce7;
      color: #166534;
    }

    .amount {
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
    }

    .empty-state {
      text-align: center;
      padding: 18px 8px 10px;
      color: var(--text-soft);
      font-size: 0.8rem;
    }

    .detail-title {
      margin: 0 0 4px;
      font-size: 0.95rem;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .detail-sub {
      margin: 0;
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .detail-grid {
      margin-top: 10px;
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 8px;
      font-size: 0.78rem;
    }

    .detail-row-label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-soft);
      margin-bottom: 1px;
    }

    .detail-row-value {
      background: #f9fafb;
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px solid #e5e7eb;
      min-height: 28px;
      white-space: pre-wrap;
    }

    .detail-hint {
      margin-top: 10px;
      font-size: 0.72rem;
      color: var(--text-soft);
    }

    .pill-small {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.7rem;
      border: 1px dashed #e5e7eb;
      color: #6b7280;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .detail-actions {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    /* Overlays / Modals */

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.28);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 40;
      padding: 16px;
    }

    .overlay.hidden {
      display: none;
    }

    .modal {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 24px 60px rgba(15,23,42,0.35);
      max-width: 620px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(209,213,219,0.9);
    }

    .modal-header {
      padding: 14px 18px 10px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }

    .modal-title {
      font-size: 0.95rem;
      margin: 0 0 2px;
    }

    .modal-sub {
      margin: 0;
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .modal-body {
      padding: 12px 18px 4px;
      overflow: auto;
    }

    .modal-footer {
      padding: 10px 18px 12px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-icon {
      border-radius: 999px;
      border: none;
      width: 26px;
      height: 26px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: #f3f4f6;
      color: #6b7280;
      font-size: 0.85rem;
    }

    .stepper {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .step-pill {
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 0.72rem;
      border: 1px solid #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #6b7280;
    }

    .step-pill.active {
      border-color: #2563eb;
      background: #dbeafe;
      color: #1d4ed8;
      font-weight: 500;
    }

    .step-index {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 1px solid currentColor;
      font-size: 0.65rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .row-2col {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    @media (max-width: 640px) {
      .modal {
        max-width: 100%;
      }
      .row-2col {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .helper-text {
      font-size: 0.72rem;
      color: var(--text-soft);
      margin-top: 3px;
    }

    .badge-mini {
      font-size: 0.7rem;
      border-radius: 999px;
      padding: 1px 7px;
      border: 1px dashed #e5e7eb;
      color: #6b7280;
    }

    .text-danger {
      color: var(--danger);
    }

  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="header-title">
        <div class="logo-pill">CM</div>
        <div>
          <h1>Gesti√≥ de contractes menors</h1>
          <p>Servei d‚ÄôInfraestructures Educatives ¬∑ Prototip clicable</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary" id="btnNouContracte">
          <span>Ôºã</span> <span>Nou contracte menor</span>
        </button>
        <div class="header-badge">
          <span>üß™</span> <span>Flux: alta ¬∑ consulta ¬∑ seguiment</span>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="layout">
      <!-- FILTRES -->
      <section class="card">
        <h2>
          Filtres
          <button id="resetFiltersBtn" class="btn btn-ghost" style="padding:3px 9px;font-size:0.72rem;">
            Neteja
          </button>
        </h2>
        <p class="muted">Explora els contractes menors per illa, centre, tipus i estat. Clica una fila per veure el detall.</p>

        <div class="filters-grid" style="margin-top:8px;">
          <div>
            <label for="textFilter">Cerca (centre o actuaci√≥)</label>
            <input type="text" id="textFilter" class="pill-input" placeholder="Ex: goteres, IES Sa Serra..." />
          </div>
          <div>
            <label for="tipusFilter">Tipus</label>
            <select id="tipusFilter" class="pill-input">
              <option value="">Tots</option>
              <option value="Obres">Obres</option>
              <option value="Equipament">Equipament</option>
            </select>
          </div>
          <div>
            <label for="illaFilter">Illa</label>
            <select id="illaFilter" class="pill-input">
              <option value="">Totes</option>
              <option value="Mallorca">Mallorca</option>
              <option value="Menorca">Menorca</option>
              <option value="Eivissa">Eivissa</option>
              <option value="Formentera">Formentera</option>
            </select>
          </div>
          <div>
            <label for="estatFilter">Estat</label>
            <select id="estatFilter" class="pill-input">
              <option value="">Tots</option>
              <option value="En tr√†mit">En tr√†mit</option>
              <option value="En curs">En curs</option>
              <option value="Tancat">Tancat</option>
            </select>
          </div>
        </div>

        <div class="chip-row">
          <span class="chip" data-quick="obres">Nom√©s obres</span>
          <span class="chip" data-quick="equipament">Nom√©s equipament</span>
          <span class="chip" data-quick="mallorca">Nom√©s Mallorca</span>
          <span class="chip" data-quick="pendent">Nom√©s en tr√†mit</span>
        </div>
      </section>

      <!-- LLISTAT -->
      <section class="card" style="overflow:hidden;display:flex;flex-direction:column;">
        <div class="list-header">
          <h2>Llistat de contractes</h2>
          <div id="resultCount" class="muted"></div>
        </div>
        <div class="summary" id="summaryBar"></div>

        <div style="margin-top:6px;overflow:auto;max-height:420px;">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Centre</th>
                <th>Illa</th>
                <th>Tipus</th>
                <th>Actuaci√≥</th>
                <th>Import (sense IVA)</th>
                <th>Estat</th>
              </tr>
            </thead>
            <tbody id="contractsTableBody">
              <!-- Files generades per JS -->
            </tbody>
          </table>
          <div id="emptyState" class="empty-state" style="display:none;">
            No s‚Äôhan trobat contractes amb aquests filtres.
          </div>
        </div>
      </section>

      <!-- DETALL -->
      <aside class="card" id="detailPanel">
        <h2>Detall del contracte</h2>
        <p class="muted">Selecciona una fila del llistat per veure‚Äôn la informaci√≥ i actualitzar-ne el seguiment.</p>

        <div id="detailContent" style="margin-top:10px;">
          <!-- Contingut de detall generat per JS -->
        </div>
      </aside>
    </div>
  </main>

  <!-- MODAL: ASSISTENT NOU CONTRACTE -->
  <div class="overlay hidden" id="wizardOverlay">
    <div class="modal">
      <div class="modal-header">
        <div>
          <h3 class="modal-title">Nou contracte menor</h3>
          <p class="modal-sub">
            Assistent r√†pid per donar d‚Äôalta una actuaci√≥ d‚Äôobres o d‚Äôequipament.
          </p>
          <div class="stepper">
            <div class="step-pill" data-step-pill="0">
              <span class="step-index">1</span> Tipus i centre
            </div>
            <div class="step-pill" data-step-pill="1">
              <span class="step-index">2</span> Imports
            </div>
            <div class="step-pill" data-step-pill="2">
              <span class="step-index">3</span> Seguiment inicial
            </div>
          </div>
        </div>
        <button class="btn-icon" id="wizardClose">‚úï</button>
      </div>
      <div class="modal-body">
        <!-- PAS 1 -->
        <div data-step="0">
          <div class="row-2col">
            <div>
              <label for="wTipus">Tipus de contracte</label>
              <select id="wTipus">
                <option value="">Selecciona...</option>
                <option value="Obres">Obres</option>
                <option value="Equipament">Equipament</option>
              </select>
              <div class="helper-text">
                Diferencia obres a centres (manteniment, reformes, etc.) i adquisici√≥ d‚Äôequipament.
              </div>
            </div>
            <div>
              <label for="wData">Data de registre</label>
              <input type="date" id="wData" />
            </div>
          </div>

          <div style="margin-top:8px;">
            <label for="wCentre">Centre educatiu</label>
            <input type="text" id="wCentre" placeholder="Ex: IES Sa Serra" />
          </div>

          <div style="margin-top:8px;" class="row-2col">
            <div>
              <label for="wIlla">Illa</label>
              <select id="wIlla">
                <option value="">Selecciona...</option>
                <option value="Mallorca">Mallorca</option>
                <option value="Menorca">Menorca</option>
                <option value="Eivissa">Eivissa</option>
                <option value="Formentera">Formentera</option>
              </select>
            </div>
            <div>
              <label for="wEmpresa">Empresa adjudicat√†ria (si es coneix)</label>
              <input type="text" id="wEmpresa" placeholder="Opcional a l‚Äôinici" />
            </div>
          </div>

          <div style="margin-top:8px;">
            <label for="wDescripcio">Descripci√≥ de l‚Äôactuaci√≥</label>
            <textarea id="wDescripcio" placeholder="Ex: Reparaci√≥ de goteres al gimn√†s..."></textarea>
          </div>
        </div>

        <!-- PAS 2 -->
        <div data-step="1" style="display:none;">
          <div class="row-2col">
            <div>
              <label for="wImportSenseIVA">Import previst (sense IVA)</label>
              <input type="number" id="wImportSenseIVA" step="0.01" min="0" />
              <div class="helper-text">
                Import del pressupost de licitaci√≥ o proposta inicial.
              </div>
            </div>
            <div>
              <label for="wImportAmbIVA">Import execuci√≥ / amb IVA</label>
              <input type="number" id="wImportAmbIVA" step="0.01" min="0" />
              <div class="helper-text">
                Es pot omplir m√©s endavant quan hi hagi factura.
              </div>
            </div>
          </div>

          <div style="margin-top:8px;">
            <label for="wObservacions">Observacions internes</label>
            <textarea id="wObservacions" placeholder="Partida pressupost√†ria, notes internes, etc."></textarea>
          </div>
        </div>

        <!-- PAS 3 -->
        <div data-step="2" style="display:none;">
          <label for="wSeguiment">Seguiment inicial</label>
          <textarea id="wSeguiment" placeholder="Ex: Annex 2 favorable. Enviat al centre per Annex 3."></textarea>
          <div class="helper-text">
            Pots indicar en quin punt del flux es troba (Annex 2, UGE, pendent de factura, etc.).
          </div>

          <div style="margin-top:10px;">
            <span class="badge-mini">Suggeriments r√†pids</span>
            <div class="chip-row">
              <span class="chip" data-wseguiment="Annex 2 favorable. Enviat al centre per Annex 3.">
                Annex 2 favorable
              </span>
              <span class="chip" data-wseguiment="Enviat a UGE. Pendent aprovaci√≥ i comunicaci√≥ al centre.">
                Enviat a UGE
              </span>
              <span class="chip" data-wseguiment="Actuaci√≥ finalitzada. Pendent recepci√≥ factura.">
                Finalitzat pendent factura
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <div class="helper-text" id="wizardStatus">
          Pas 1 de 3 ¬∑ Tipus i centre
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          <button class="btn btn-ghost" id="wizardBack" disabled>Enrere</button>
          <button class="btn btn-primary" id="wizardNext">Seg√ºent</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: ACTUALITZAR SEGUIMENT -->
  <div class="overlay hidden" id="seguimentOverlay">
    <div class="modal">
      <div class="modal-header">
        <div>
          <h3 class="modal-title">Actualitzar seguiment</h3>
          <p class="modal-sub" id="seguimentTitle">
            Contracte seleccionat
          </p>
        </div>
        <button class="btn-icon" id="seguimentClose">‚úï</button>
      </div>
      <div class="modal-body">
        <label for="sSeguiment">Nou text de seguiment</label>
        <textarea id="sSeguiment"></textarea>
        <div class="helper-text">
          Introdueix l‚Äôestat actual: Annex 2/3, si est√† a UGE, si hi ha factura, si l‚Äôactuaci√≥ est√† finalitzada, etc.
          El sistema calcular√† l‚Äôestat (En tr√†mit / En curs / Tancat) a partir del text.
        </div>

        <div style="margin-top:10px;">
          <span class="badge-mini">Plantilles d‚Äôestat habitual</span>
          <div class="chip-row">
            <span class="chip" data-sseguiment="Annex 2 favorable. Enviat al centre i UGE. Annex 3 pendent.">
              Annex 3 pendent
            </span>
            <span class="chip" data-sseguiment="Annex 3 signat. Actuaci√≥ finalitzada. Pendent factura.">
              Finalitzada pendent factura
            </span>
            <span class="chip" data-sseguiment="Annex 3 signat. Actuaci√≥ finalitzada i factura registrada. Contracte tancat.">
              Tancat amb factura
            </span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <span class="helper-text text-danger" id="seguimentError"></span>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          <button class="btn btn-ghost" id="seguimentCancel">Cancel¬∑la</button>
          <button class="btn btn-primary" id="seguimentSave">Desa seguiment</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------
    // Dades d‚Äôexemple (mock)
    // ---------------------------
    let nextId = 7;
    let selectedId = null;

    const CONTRACTES = [
      {
        id: 1,
        tipus: "Obres",
        data: "2024-02-01",
        centre: "IES Sa Serra",
        illa: "Eivissa",
        descripcio: "Pintar i reparar fa√ßana",
        importSenseIVA: 36996.78,
        importAmbIVA: 44766.10,
        seguiment: "Annex 2 favorable. Enviat a delegaci√≥ i UGE. Conformitat del centre pendent de factura.",
        empresa: "Argenis Pareja Buritica (MIRAPA)",
        observacions: ""
      },
      {
        id: 2,
        tipus: "Obres",
        data: "2024-02-01",
        centre: "CEIP Es Fossaret",
        illa: "Mallorca",
        descripcio: "Reparaci√≥ de goteres",
        importSenseIVA: 7256.09,
        importAmbIVA: 8779.87,
        seguiment: "Annex 2 favorable. Enviat al centre i UGE. Annex 3 pendent.",
        empresa: "Promocions i Construccions Jam S√≥ller S.L.",
        observacions: ""
      },
      {
        id: 3,
        tipus: "Obres",
        data: "2024-03-01",
        centre: "CEIP Es Molinar",
        illa: "Mallorca",
        descripcio: "Reconversi√≥ de tres lavabos en dues sales a l‚Äôedificaci√≥ annexa d‚Äôeducaci√≥ infantil",
        importSenseIVA: 9173.10,
        importAmbIVA: 11099.45,
        seguiment: "Pendent ampliar partida i trametre a UGE. Annex 3 preparat.",
        empresa: "Construcciones y Mejoras Sa Torre S.L.",
        observacions: ""
      },
      {
        id: 4,
        tipus: "Equipament",
        data: "2024-03-01",
        centre: "CEIP Sant Llu√≠s i CEIP Mare de D√©u del Carme",
        illa: "Menorca",
        descripcio: "Equipament cuina: fregidora i trituradora",
        importSenseIVA: 10000,
        importAmbIVA: null,
        seguiment: "Enviat a UGE. Annexos en tramitaci√≥ amb els centres.",
        empresa: "NET NET S.C.",
        observacions: ""
      },
      {
        id: 5,
        tipus: "Equipament",
        data: "2024-04-01",
        centre: "CEIP Can Pastilla",
        illa: "Mallorca",
        descripcio: "Cistelles d‚Äôequipament esportiu",
        importSenseIVA: 6931.68,
        importAmbIVA: null,
        seguiment: "Enviat a UGE. Pendent confirmaci√≥ d‚Äôinstal¬∑laci√≥ i factura.",
        empresa: "Vallados Ibiza S.L.",
        observacions: ""
      },
      {
        id: 6,
        tipus: "Equipament",
        data: "2024-05-01",
        centre: "CEIP Sant Ferran de ses Roques",
        illa: "Formentera",
        descripcio: "Equipament cuina (marmita, etc.)",
        importSenseIVA: 15400,
        importAmbIVA: null,
        seguiment: "Annex 3 signat i enviat a UGE. Actuaci√≥ finalitzada.",
        empresa: "Equipaments Mediterranis S.L.",
        observacions: "Exemple simplificat per al prototip."
      }
    ];

    const formatter = new Intl.NumberFormat("ca-ES", {
      style: "currency",
      currency: "EUR",
      minimumFractionDigits: 2
    });

    function formatEuro(value) {
      if (value === null || value === undefined || value === "" || isNaN(value)) return "-";
      return formatter.format(value);
    }

    function getEstat(contracte) {
      const txt = (contracte.seguiment || "").toLowerCase();
      if (txt.includes("finalitzad") || txt.includes("tancat") || txt.includes("annex 3 signat")) {
        return "Tancat";
      }
      if (txt.includes("pendent")) {
        return "En tr√†mit";
      }
      return "En curs";
    }

    // ---------------------------
    // Render llistat i resum
    // ---------------------------
    function renderTable() {
      const tbody = document.getElementById("contractsTableBody");
      const emptyState = document.getElementById("emptyState");
      const resultCount = document.getElementById("resultCount");

      const textFilter = document.getElementById("textFilter").value.trim().toLowerCase();
      const tipusFilter = document.getElementById("tipusFilter").value;
      const illaFilter = document.getElementById("illaFilter").value;
      const estatFilter = document.getElementById("estatFilter").value;

      const filtered = CONTRACTES.filter(c => {
        if (tipusFilter && c.tipus !== tipusFilter) return false;
        if (illaFilter && c.illa !== illaFilter) return false;

        const estatActual = getEstat(c);
        if (estatFilter && estatFilter !== estatActual) return false;

        if (textFilter) {
          const blob = (c.centre + " " + c.descripcio).toLowerCase();
          if (!blob.includes(textFilter)) return false;
        }
        return true;
      });

      tbody.innerHTML = "";

      if (filtered.length === 0) {
        emptyState.style.display = "block";
        resultCount.textContent = "0 contractes";
      } else {
        emptyState.style.display = "none";
        resultCount.textContent = filtered.length + (filtered.length === 1 ? " contracte" : " contractes");
      }

      filtered.forEach(c => {
        const estat = getEstat(c);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.data || "-"}</td>
          <td>${c.centre}</td>
          <td>${c.illa || "-"}</td>
          <td>
            <span class="tag ${c.tipus === "Obres" ? "tag-obres" : "tag-equipament"}">
              ${c.tipus}
            </span>
          </td>
          <td>${c.descripcio}</td>
          <td class="amount">${formatEuro(c.importSenseIVA)}</td>
          <td>
            <span class="badge-estat ${
              estat === "Tancat"
                ? "estat-tancat"
                : estat === "En tr√†mit"
                ? "estat-tramit"
                : "estat-curs"
            }">${estat}</span>
          </td>
        `;
        tr.addEventListener("click", () => {
          selectedId = c.id;
          renderDetail(c);
        });
        tbody.appendChild(tr);
      });

      renderSummary(filtered);

      // selecciona primer si no hi ha cap seleccionat
      if (filtered.length > 0) {
        const existent = filtered.find(c => c.id === selectedId);
        renderDetail(existent || filtered[0]);
        selectedId = (existent || filtered[0]).id;
      } else {
        clearDetail();
      }
    }

    function renderSummary(list) {
      const el = document.getElementById("summaryBar");
      const total = list.length;
      const numObres = list.filter(c => c.tipus === "Obres").length;
      const numEquip = list.filter(c => c.tipus === "Equipament").length;
      const sumaSenseIVA = list.reduce((acc, c) => acc + (parseFloat(c.importSenseIVA) || 0), 0);

      el.innerHTML = `
        <div class="summary-pill">
          <span class="summary-dot"></span>
          <span>${total || 0} contractes</span>
        </div>
        <div class="summary-pill">
          <span class="summary-dot obres"></span>
          <span>${numObres} obres</span>
        </div>
        <div class="summary-pill">
          <span class="summary-dot equip"></span>
          <span>${numEquip} equipament</span>
        </div>
        <div class="summary-pill">
          üí∂ Total previst (sense IVA): <strong>${formatEuro(sumaSenseIVA)}</strong>
        </div>
      `;
    }

    // ---------------------------
    // Detall del contracte
    // ---------------------------
    function renderDetail(contracte) {
      const container = document.getElementById("detailContent");
      if (!contracte) {
        clearDetail();
        return;
      }
      const estat = getEstat(contracte);

      container.innerHTML = `
        <h3 class="detail-title">
          ${contracte.centre}
          <span class="tag ${contracte.tipus === "Obres" ? "tag-obres" : "tag-equipament"}">${contracte.tipus}</span>
        </h3>
        <p class="detail-sub">${contracte.descripcio}</p>

        <div class="detail-grid">
          <div>
            <div class="detail-row-label">Data i illa</div>
            <div class="detail-row-value">
              ${contracte.data || "-"} ¬∑ ${contracte.illa || "-"}
            </div>
          </div>

          <div>
            <div class="detail-row-label">Imports</div>
            <div class="detail-row-value">
              Import previst (sense IVA): <strong>${formatEuro(contracte.importSenseIVA)}</strong><br/>
              Import execuci√≥ / amb IVA: <strong>${formatEuro(contracte.importAmbIVA)}</strong>
            </div>
          </div>

          <div>
            <div class="detail-row-label">Estat i seguiment</div>
            <div class="detail-row-value">
              <span class="badge-estat ${
                estat === "Tancat"
                  ? "estat-tancat"
                  : estat === "En tr√†mit"
                  ? "estat-tramit"
                  : "estat-curs"
              }">${estat}</span><br/><br/>
              ${contracte.seguiment || "<span class='muted'>Sense informaci√≥ de seguiment.</span>"}
            </div>
          </div>

          <div>
            <div class="detail-row-label">Empresa adjudicada</div>
            <div class="detail-row-value">
              ${contracte.empresa || "-"}
            </div>
          </div>

          <div>
            <div class="detail-row-label">Observacions internes</div>
            <div class="detail-row-value">
              ${contracte.observacions || "<span class='muted'>Cap observaci√≥ afegida.</span>"}
            </div>
          </div>
        </div>

        <div class="detail-actions">
          <button class="btn btn-primary" id="btnActualitzarSeguiment">
            üìù Actualitza seguiment
          </button>
          <button class="btn btn-ghost" disabled title="Nom√©s demostraci√≥">
            ‚úèÔ∏è Edita dades b√†siques (mock)
          </button>
        </div>

        <div class="detail-hint">
          <span class="pill-small">
            üîÅ Flux de treball: alta de contracte, consulta i actualitzaci√≥ de seguiment.
          </span>
        </div>
      `;

      const btnSeg = document.getElementById("btnActualitzarSeguiment");
      btnSeg.addEventListener("click", () => openSeguimentModal(contracte));
    }

    function clearDetail() {
      const container = document.getElementById("detailContent");
      container.innerHTML = `
        <p class="muted">No hi ha resultats amb aquests filtres. Modifica la cerca per veure contractes.</p>
      `;
    }

    // ---------------------------
    // Filtres i xips r√†pids
    // ---------------------------
    function setupFilters() {
      document.getElementById("textFilter").addEventListener("input", renderTable);
      document.getElementById("tipusFilter").addEventListener("change", renderTable);
      document.getElementById("illaFilter").addEventListener("change", renderTable);
      document.getElementById("estatFilter").addEventListener("change", renderTable);

      document.getElementById("resetFiltersBtn").addEventListener("click", () => {
        document.getElementById("textFilter").value = "";
        document.getElementById("tipusFilter").value = "";
        document.getElementById("illaFilter").value = "";
        document.getElementById("estatFilter").value = "";
        document.querySelectorAll(".chip").forEach(ch => ch.classList.remove("active"));
        renderTable();
      });

      document.querySelectorAll(".chip").forEach(chip => {
        const quick = chip.getAttribute("data-quick");
        if (!quick) return;
        chip.addEventListener("click", () => {
          document.querySelectorAll(".chip[data-quick]").forEach(c => c.classList.remove("active"));
          chip.classList.add("active");

          if (quick === "obres") {
            document.getElementById("tipusFilter").value = "Obres";
            document.getElementById("estatFilter").value = "";
          } else if (quick === "equipament") {
            document.getElementById("tipusFilter").value = "Equipament";
            document.getElementById("estatFilter").value = "";
          } else if (quick === "mallorca") {
            document.getElementById("illaFilter").value = "Mallorca";
          } else if (quick === "pendent") {
            document.getElementById("estatFilter").value = "En tr√†mit";
          }
          renderTable();
        });
      });
    }

    // ---------------------------
    // Assistent nou contracte
    // ---------------------------
    const wizardOverlay = document.getElementById("wizardOverlay");
    const wizardClose = document.getElementById("wizardClose");
    const wizardBack = document.getElementById("wizardBack");
    const wizardNext = document.getElementById("wizardNext");
    const wizardStatus = document.getElementById("wizardStatus");

    let wizardStep = 0;
    const WIZARD_STEPS = [
      "Tipus i centre",
      "Imports",
      "Seguiment inicial"
    ];

    function openWizard() {
      wizardOverlay.classList.remove("hidden");
      wizardStep = 0;
      updateWizardUI();
      clearWizardFields();
    }

    function closeWizard() {
      wizardOverlay.classList.add("hidden");
    }

    function updateWizardUI() {
      document.querySelectorAll('[data-step]').forEach(el => {
        const step = parseInt(el.getAttribute("data-step"), 10);
        el.style.display = step === wizardStep ? "block" : "none";
      });

      document.querySelectorAll("[data-step-pill]").forEach(el => {
        const step = parseInt(el.getAttribute("data-step-pill"), 10);
        el.classList.toggle("active", step === wizardStep);
      });

      wizardBack.disabled = wizardStep === 0;
      wizardNext.textContent = wizardStep === WIZARD_STEPS.length - 1 ? "Desa contracte" : "Seg√ºent";

      wizardStatus.textContent = `Pas ${wizardStep + 1} de ${WIZARD_STEPS.length} ¬∑ ${WIZARD_STEPS[wizardStep]}`;
    }

    function clearWizardFields() {
      document.getElementById("wTipus").value = "";
      document.getElementById("wData").value = "";
      document.getElementById("wCentre").value = "";
      document.getElementById("wIlla").value = "";
      document.getElementById("wEmpresa").value = "";
      document.getElementById("wDescripcio").value = "";
      document.getElementById("wImportSenseIVA").value = "";
      document.getElementById("wImportAmbIVA").value = "";
      document.getElementById("wObservacions").value = "";
      document.getElementById("wSeguiment").value = "";
    }

    function validateCurrentStep() {
      // Validaci√≥ m√≠nima per simulaci√≥
      if (wizardStep === 0) {
        const tipus = document.getElementById("wTipus").value;
        const centre = document.getElementById("wCentre").value.trim();
        if (!tipus || !centre) {
          alert("Has d‚Äôindicar com a m√≠nim el tipus de contracte i el centre.");
          return false;
        }
      }
      if (wizardStep === 1) {
        // sense validaci√≥ estricta
      }
      if (wizardStep === 2) {
        // seguiment opcional
      }
      return true;
    }

    function createContractFromWizard() {
      const tipus = document.getElementById("wTipus").value || "Obres";
      const data = document.getElementById("wData").value || "";
      const centre = document.getElementById("wCentre").value || "Centre sense nom";
      const illa = document.getElementById("wIlla").value || "";
      const empresa = document.getElementById("wEmpresa").value || "";
      const descripcio = document.getElementById("wDescripcio").value || "";
      const importSenseIVA = parseFloat(document.getElementById("wImportSenseIVA").value || "0");
      const importAmbIVA = document.getElementById("wImportAmbIVA").value ? parseFloat(document.getElementById("wImportAmbIVA").value) : null;
      const observacions = document.getElementById("wObservacions").value || "";
      const seguiment = document.getElementById("wSeguiment").value || "En tr√†mit. Detall pendent d‚Äôactualitzar.";

      const nou = {
        id: nextId++,
        tipus,
        data,
        centre,
        illa,
        descripcio,
        importSenseIVA,
        importAmbIVA,
        seguiment,
        empresa,
        observacions
      };

      CONTRACTES.push(nou);
      selectedId = nou.id;
      renderTable();
      closeWizard();
    }

    // Xips per omplir seguiment (pas 3)
    document.addEventListener("click", (ev) => {
      const target = ev.target;
      if (target.matches(".chip[data-wseguiment]")) {
        const txt = target.getAttribute("data-wseguiment");
        const textarea = document.getElementById("wSeguiment");
        textarea.value = txt;
      }
    });

    // ---------------------------
    // Modal seguiment
    // ---------------------------
    const seguimentOverlay = document.getElementById("seguimentOverlay");
    const seguimentTitle = document.getElementById("seguimentTitle");
    const sSeguiment = document.getElementById("sSeguiment");
    const seguimentError = document.getElementById("seguimentError");

    function openSeguimentModal(contracte) {
      seguimentTitle.textContent = contracte.centre + " ¬∑ " + contracte.descripcio;
      sSeguiment.value = contracte.seguiment || "";
      seguimentError.textContent = "";
      seguimentOverlay.classList.remove("hidden");
    }

    function closeSeguimentModal() {
      seguimentOverlay.classList.add("hidden");
    }

    document.addEventListener("click", (ev) => {
      const t = ev.target;
      if (t.matches(".chip[data-sseguiment]")) {
        const txt = t.getAttribute("data-sseguiment");
        sSeguiment.value = txt;
      }
    });

    // ---------------------------
    // Events generals
    // ---------------------------
    function setupWizardEvents() {
      document.getElementById("btnNouContracte").addEventListener("click", openWizard);
      wizardClose.addEventListener("click", closeWizard);
      wizardBack.addEventListener("click", () => {
        if (wizardStep > 0) {
          wizardStep--;
          updateWizardUI();
        }
      });
      wizardNext.addEventListener("click", () => {
        if (!validateCurrentStep()) return;
        if (wizardStep < WIZARD_STEPS.length - 1) {
          wizardStep++;
          updateWizardUI();
        } else {
          createContractFromWizard();
        }
      });

      // tancar si fem clic fora (nom√©s per demo)
      wizardOverlay.addEventListener("click", (ev) => {
        if (ev.target === wizardOverlay) {
          closeWizard();
        }
      });
    }

    function setupSeguimentEvents() {
      const seguimentClose = document.getElementById("seguimentClose");
      const seguimentCancel = document.getElementById("seguimentCancel");
      const seguimentSave = document.getElementById("seguimentSave");

      seguimentClose.addEventListener("click", closeSeguimentModal);
      seguimentCancel.addEventListener("click", closeSeguimentModal);

      seguimentSave.addEventListener("click", () => {
        const text = sSeguiment.value.trim();
        if (!text) {
          seguimentError.textContent = "El seguiment no pot quedar completament buit.";
          return;
        }
        const idx = CONTRACTES.findIndex(c => c.id === selectedId);
        if (idx === -1) {
          seguimentError.textContent = "No s‚Äôha trobat el contracte seleccionat.";
          return;
        }
        CONTRACTES[idx].seguiment = text;
        renderTable();
        closeSeguimentModal();
      });

      seguimentOverlay.addEventListener("click", (ev) => {
        if (ev.target === seguimentOverlay) {
          closeSeguimentModal();
        }
      });
    }

    // Inicialitzaci√≥
    setupFilters();
    setupWizardEvents();
    setupSeguimentEvents();
    renderTable();
  </script>
</body>
</html>
